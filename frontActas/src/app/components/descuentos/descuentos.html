<section class="descuentos-panel mat-elevation-z3">
  <!-- Header responsivo -->
  <header class="header">
    <div class="search">
      <label class="label">Buscar por DNI</label>
      <div class="search-row">
        <input matInput 
               placeholder="DNI (ej. 12345678)" 
               [formControl]="dni" 
               (keyup.enter)="searchByDni()" />
        <button mat-flat-button color="primary" (click)="searchByDni()">
          <mat-icon>search</mat-icon>
          <span class="desktop-only">Buscar</span>
        </button>
      </div>
      <div class="error" *ngIf="dni.invalid && dni.touched">
        DNI inválido — ingresa 6 a 8 dígitos.
      </div>
      <div class="error" *ngIf="errorMsg">{{ errorMsg }}</div>
    </div>

    <div class="quick-controls">
      <button mat-stroked-button 
              color="primary" 
              (click)="selectYear(selectedYear ?? years[0])" 
              *ngIf="years.length">
        <mat-icon>calendar_today</mat-icon>
        <span>Año: {{ selectedYear ?? 'Todos' }}</span>
      </button>
    </div>
  </header>

  <mat-divider></mat-divider>

  <!-- Chips de años responsivos -->
  <div class="years-row" *ngIf="years.length">
    <span class="years-label">Años:</span>
    <div class="chips" role="list">
      <button
        role="listitem"
        class="chip"
        *ngFor="let y of years"
        (click)="selectYear(y)"
        [class.selected]="selectedYear === y"
        type="button"
      >
        {{ y }}
      </button>
    </div>
  </div>

  <!-- Info para todos los años -->
  <div class="info info-all" *ngIf="isAllYearsSelected && years.length">
    <strong>Vista completa:</strong> Mostrando sumatoria de todos los años disponibles. 
    Los valores mensuales están agregados por mes (Ene–Dic) sumando todos los años.
  </div>

  <mat-divider></mat-divider>

  <!-- Contenido principal -->
  <main class="content">
    <div class="egresos-header">
      <h3>Egresos</h3>
      <div class="total">
        <span class="desktop-only">{{ isAllYearsSelected ? 'Total (Todos los años):' : 'Total:' }}</span>
        <span class="mobile-only">Total:</span>
        <strong>{{ totalEgresos | currency:'S/.':'symbol':'1.2-2' }}</strong>
      </div>
    </div>

    <div class="egresos-list" *ngIf="loaded; else loading">
      <div class="egreso-row" *ngFor="let e of egresos; trackBy: trackByEgreso">
        <!-- Botón principal -->
        <button class="egreso-button" 
                (click)="toggleExpand(e)" 
                type="button" 
                [attr.aria-expanded]="e.expanded">
          <div class="row-main">
            <div class="concepto">{{ e.concepto }}</div>
            <div class="monto">{{ e.monto | currency:'S/.':'symbol':'1.2-2' }}</div>
          </div>
          <div class="chev">
            <mat-icon>{{ e.expanded ? 'expand_less' : 'expand_more' }}</mat-icon>
          </div>
        </button>

        <!-- Detalles expandidos -->
        <div class="row-details" *ngIf="e.expanded">
          
          <!-- Vista Desktop: Grid 12 columnas -->
          <div class="desktop-only">
            <div class="months-grid">
              <!-- Headers -->
              <div class="month-header" *ngFor="let m of months; let i = index">
                {{ m }}
              </div>
              <!-- Values -->
              <div class="month-value" *ngFor="let _ of months; let i = index">
                <span *ngIf="e.monthly && e.monthly[i] > 0; else dash">
                  {{ e.monthly[i] | currency:'S/.':'symbol':'1.2-2' }}
                </span>
                <ng-template #dash> - </ng-template>
              </div>
            </div>
          </div>

          <!-- Vista Móvil: Tarjetas -->
          <div class="mobile-only">
            <div class="mobile-months">
              <div class="mobile-month-card" 
                   *ngFor="let m of months; let i = index"
                   [class.has-value]="e.monthly && e.monthly[i] > 0">
                <div class="month-name">{{ m }}</div>
                <div class="month-amount">
                  <span *ngIf="e.monthly && e.monthly[i] > 0; else mobileDash">
                    {{ e.monthly[i] | currency:'S/.':'symbol':'1.2-2' }}
                  </span>
                  <ng-template #mobileDash>-</ng-template>
                </div>
              </div>
            </div>
          </div>

          <!-- Resumen mensual -->
          <div class="monthly-summary">
            <div>
              <strong>Subtotal meses:</strong>
              {{ monthlySum(e) | currency:'S/.':'symbol':'1.2-2' }}
            </div>
            <div *ngIf="(monthlySum(e) | number:'1.2-2') !== (e.monto | number:'1.2-2')" 
                 class="warn">
              ⚠️ El total por meses no coincide exactamente con el monto (posible redondeo).
            </div>
            <div class="info-inline" *ngIf="isAllYearsSelected">
              Montos agregados de todos los años.
            </div>
          </div>
        </div>
      </div>

      <!-- Estado vacío -->
      <div class="empty" *ngIf="egresos.length === 0">
        No hay egresos para mostrar.
      </div>
    </div>

    <!-- Loading state -->
    <ng-template #loading>
      <div class="loading">Cargando datos...</div>
    </ng-template>
  </main>
</section>