<mat-card class="import-card">
  <div class="header">
    <div class="title">
      <mat-icon>file_upload</mat-icon>
      <h2>Importar CSV</h2>
    </div>
    <div class="hint">Sube uno o varios archivos CSV; se subirán en cola, uno a uno.</div>
  </div>

  <!-- Zona Drag & Drop: click en la zona abre el file picker -->
  <div class="dropzone" [class.active]="dragActive" (click)="fileInput.click()">
    <mat-icon class="cloud">cloud_upload</mat-icon>
    <p>Arrastra y suelta tus archivos CSV aquí</p>
    <span class="or">o</span>

    <!-- Input oculto y botón que lo dispara -->
    <input
      #fileInput
      id="fileInput"
      type="file"
      accept=".csv,text/csv"
      (change)="onFilesSelected($event)"
      multiple
      hidden
    />
    <!-- STOP PROPAGATION en el botón para evitar que el click burbujee al padre -->
    <button mat-raised-button color="primary" type="button" (click)="openFilePicker(fileInput); $event.stopPropagation()">
      <mat-icon>attach_file</mat-icon>
      Seleccionar CSV(s)
    </button>
  </div>

  <!-- Lista de archivos en cola -->
  <div class="queue-list" *ngIf="filesQueue.length > 0">
    <div class="queue-item" *ngFor="let item of filesQueue; let i = index">
      <div class="info">
        <strong>{{ item.file.name }}</strong>
        <span class="size"> — {{ (item.file.size / 1024) | number:'1.0-0' }} KB</span>
        <span class="status">
          <ng-container [ngSwitch]="item.status">
            <span *ngSwitchCase="'pending'">[Pendiente]</span>
            <span *ngSwitchCase="'uploading'">[Subiendo]</span>
            <span *ngSwitchCase="'done'"> <mat-icon color="primary" inline>check_circle</mat-icon> Completado</span>
            <span *ngSwitchCase="'error'"> <mat-icon color="warn" inline>error</mat-icon> Falló</span>
            <span *ngSwitchCase="'canceled'">[Cancelado]</span>
          </ng-container>
        </span>
      </div>

      <mat-progress-bar mode="determinate" [value]="item.progress"></mat-progress-bar>

      <div class="actions">
        <button mat-button color="primary" (click)="retryItem(i)" *ngIf="item.status==='error'">Reintentar</button>
        <button mat-button color="warn" (click)="removeFromQueue(i)">Remover</button>
        <button mat-button (click)="cancelCurrent()" *ngIf="item.status==='uploading'">Cancelar actual</button>
      </div>
    </div>
  </div>

  <!-- Progreso global -->
  <div *ngIf="filesQueue.length > 0" class="global-progress">
    <p>Progreso global: {{ overallProgress }}%</p>
    <mat-progress-bar mode="determinate" [value]="overallProgress"></mat-progress-bar>
  </div>

  <!-- Acciones de cola -->
  <div class="actions">
    <button mat-flat-button color="primary" (click)="startUploadQueue()" [disabled]="uploading || filesQueue.length === 0">
      <mat-icon>cloud_done</mat-icon>
      Subir cola
    </button>
    <button mat-stroked-button color="warn" (click)="cancelCurrent()" [disabled]="!uploading">
      <mat-icon>cancel</mat-icon>
      Cancelar actual
    </button>
    <button mat-stroked-button (click)="clearQueue()" [disabled]="filesQueue.length === 0 && !uploading">
      <mat-icon>delete</mat-icon>
      Limpiar cola
    </button>
  </div>

  <!-- Mensajes generales / tips -->
  <div class="tips">
    <mat-icon>info</mat-icon>
    <span>Tamaño máximo por archivo: 10 MB. Puedes agregar varios archivos y se subirán uno a uno.</span>
  </div>
</mat-card>